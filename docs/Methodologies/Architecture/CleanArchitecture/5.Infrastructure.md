---
sidebar_label: 5. Infrastructure
sidebar_position: 5
---

AprÃ¨s avoir explorÃ© les couches **Domain**, **Application**, il est temps de sâ€™intÃ©resser Ã  la couche la plusâ€¦ pragmatique : la **couche Infrastructure**.

Câ€™est ici que vivent les **dÃ©tails techniques** : base de donnÃ©es, frameworks, services externes, messagerie, etc.
Autrement dit, tout ce qui est nÃ©cessaire au fonctionnement du systÃ¨me, mais qui **ne doit jamais influencer le mÃ©tier**.

---

## 5.1. Quâ€™est-ce que la couche Infrastructure ?

La couche **Infrastructure** a un rÃ´le trÃ¨s clair :

- Fournir des **implÃ©mentations concrÃ¨tes** aux interfaces dÃ©finies dans la couche Application
- GÃ©rer la **persistance des donnÃ©es** (BDD, fichiers, cacheâ€¦)
- Communiquer avec des **services externes** (API, systÃ¨mes tiers, messagerie)
- Regrouper les composants purement techniques (logging, emailing, monitoringâ€¦)

### 5.1.1. CaractÃ©ristiques clÃ©s

- Elle **dÃ©pend de la couche Application** (et parfois indirectement du Domain via les interfaces)
- Elle contient du code **spÃ©cifique aux technologies et frameworks**
- Elle est **remplaÃ§able** sans modifier le cÅ“ur mÃ©tier

ğŸ‘‰ Lâ€™Infrastructure est **au service** de lâ€™Application, jamais lâ€™inverse.

---

## 5.2. Positionnement dans lâ€™architecture

Pour bien comprendre son rÃ´le, voici son positionnement logique :

```
Presentation  â”€â”€â–º  Application  â”€â”€â–º  Domain
                        â–²
                        â”‚
                  Infrastructure
```

Ã€ retenir :

- lâ€™Infrastructure **implÃ©mente**
- lâ€™Application **oriente**
- le Domain **dÃ©cide**

---

## 5.3. Les composants principaux

La couche Infrastructure est souvent composÃ©e de plusieurs types dâ€™adapters.

---

### 5.3.1. Les Repositories

Les **repositories** sont des implÃ©mentations concrÃ¨tes des interfaces dÃ©finies dans la couche Application.

Par exemple : implÃ©menter `IUserRepository` avec **Entity Framework Core**.

```csharp
using Microsoft.EntityFrameworkCore;

public class UserRepository : IUserRepository
{
    private readonly AppDbContext _context;

    public UserRepository(AppDbContext context)
    {
        _context = context;
    }

    public void Add(User user)
    {
        _context.Users.Add(user);
        _context.SaveChanges();
    }

    public User? GetByEmail(EmailAddress email)
    {
        return _context.Users
            .FirstOrDefault(u => u.Email.Value == email.Value);
    }

    public User? GetById(Guid id)
    {
        return _context.Users.Find(id);
    }
}
```

ğŸ‘‰ Points importants :

- Lâ€™interface (`IUserRepository`) vit en **Application**
- Lâ€™implÃ©mentation (`UserRepository`) vit en **Infrastructure**
- Changer dâ€™ORM ou de base de donnÃ©es nâ€™impacte pas lâ€™Application

---

### 5.3.2. Les services externes

La couche Infrastructure est aussi responsable des **adaptateurs vers lâ€™extÃ©rieur**.

Exemple : un service dâ€™envoi dâ€™email.

```csharp
// Port dÃ©fini cÃ´tÃ© Application
public interface IEmailService
{
    void SendEmail(string to, string subject, string body);
}

// ImplÃ©mentation Infrastructure
public class SmtpEmailService : IEmailService
{
    public void SendEmail(string to, string subject, string body)
    {
        // ImplÃ©mentation SMTP
        Console.WriteLine($"Email envoyÃ© Ã  {to} avec le sujet '{subject}'");
    }
}
```

ğŸ‘‰ Demain, remplacer SMTP par SendGrid ou AWS SES ne nÃ©cessitera **aucune modification mÃ©tier**.

---

## 5.4. Ce que lâ€™Infrastructure ne doit **jamais** faire

Pour rester saine, cette couche doit respecter des rÃ¨gles strictes ğŸš¨ :

- âŒ contenir de la logique mÃ©tier
- âŒ prendre des dÃ©cisions fonctionnelles
- âŒ exposer des concepts techniques au Domain
- âŒ dÃ©finir des rÃ¨gles applicatives

Si de la logique commence Ã  apparaÃ®tre ici, câ€™est souvent le signe que :

- une rÃ¨gle mÃ©tier est mal placÃ©e
- ou quâ€™une abstraction manque cÃ´tÃ© Application

---

## 5.5. Bonnes pratiques pour la couche Infrastructure

Quelques principes simples pour Ã©viter les dÃ©rives :

- ğŸ”Œ toujours implÃ©menter des **interfaces dÃ©finies en Application**
- ğŸ”„ concevoir des composants facilement **remplaÃ§ables**
- ğŸ§ª faciliter le **mock** et le **stub** en test
- ğŸ“¦ regrouper les composants techniques par type (persistence, messaging, external APIs)
- ğŸ§¹ accepter que cette couche change souvent

ğŸ‘‰ Une Infrastructure instable nâ€™est pas un problÃ¨meâ€¦ tant quâ€™elle est **bien isolÃ©e**.
